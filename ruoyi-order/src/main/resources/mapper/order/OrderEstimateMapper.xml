<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.order.mapper.OrderEstimateMapper">

    <resultMap type="OrderEstimate" id="OrderEstimateResult">
        <result property="id"    column="id"    />
        <result property="customerId"    column="customer_id"    />
        <result property="customerName"    column="customer_name"    />
        <result property="customerPhone"    column="customer_phone"    />
        <result property="subTotal"    column="subTotal"    />
        <result property="tax"    column="tax"    />
        <result property="taxRate"    column="tax_rate"    />
        <result property="total"    column="total"    />
        <result property="discount"    column="discount"    />
        <result property="createDate"    column="Create_date"    />
        <result property="manufacturerId"    column="manufacturer_id"    />
        <result property="color"    column="color"    />
    </resultMap>

    <resultMap id="OrderEstimateEstimateProductsResult" type="OrderEstimate" extends="OrderEstimateResult">
        <collection property="estimateProductsList" ofType="EstimateProducts" column="id" select="selectEstimateProductsList" />
    </resultMap>

    <resultMap type="EstimateProducts" id="EstimateProductsResult">
        <result property="id"    column="id"    />
        <result property="estimateId"    column="estimate_id"    />
        <result property="productCode"    column="product_code"    />
        <result property="productDescription"    column="product_description"    />
        <result property="productCount"    column="product_count"    />
        <result property="productPrice"    column="product_price"    />
        <result property="productTotal"    column="product_total"    />
    </resultMap>

    <sql id="selectOrderEstimateVo">
        select id, customer_id, customer_name, customer_phone, subTotal, tax, tax_rate, total, discount, Create_date, manufacturer_id, color from order_estimate
    </sql>

    <select id="selectOrderEstimateList" parameterType="OrderEstimate" resultMap="OrderEstimateResult">
        <include refid="selectOrderEstimateVo"/>
        <where>
            <if test="customerId != null "> and customer_id = #{customerId}</if>
            <if test="customerName != null  and customerName != ''"> and customer_name like concat('%', #{customerName}, '%')</if>
            <if test="customerPhone != null  and customerPhone != ''"> and customer_phone = #{customerPhone}</if>
            <if test="subTotal != null "> and subTotal = #{subTotal}</if>
            <if test="tax != null "> and tax = #{tax}</if>
            <if test="taxRate != null "> and tax_rate = #{taxRate}</if>
            <if test="total != null "> and total = #{total}</if>
            <if test="discount != null "> and discount = #{discount}</if>
            <if test="createDate != null "> and Create_date = #{createDate}</if>
            <if test="manufacturerId != null "> and manufacturer_id = #{manufacturerId}</if>
            <if test="color != null  and color != ''"> and color = #{color}</if>
        </where>
    </select>

    <select id="selectOrderEstimateById" parameterType="Long" resultMap="OrderEstimateEstimateProductsResult">
        select id, customer_id, customer_name, customer_phone, subTotal, tax, tax_rate, total, discount, Create_date, manufacturer_id, color
        from order_estimate
        where id = #{id}
    </select>

    <select id="selectEstimateProductsList" resultMap="EstimateProductsResult">
        select id, estimate_id, product_code, product_description, product_count, product_price, product_total
        from estimate_products
        where estimate_id = #{estimate_id}
    </select>

    <insert id="insertOrderEstimate" parameterType="OrderEstimate" useGeneratedKeys="true" keyProperty="id">
        insert into order_estimate
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="customerId != null">customer_id,</if>
            <if test="customerName != null">customer_name,</if>
            <if test="customerPhone != null">customer_phone,</if>
            <if test="subTotal != null">subTotal,</if>
            <if test="tax != null">tax,</if>
            <if test="taxRate != null">tax_rate,</if>
            <if test="total != null">total,</if>
            <if test="discount != null">discount,</if>
            <if test="createDate != null">Create_date,</if>
            <if test="manufacturerId != null">manufacturer_id,</if>
            <if test="color != null">color,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="customerId != null">#{customerId},</if>
            <if test="customerName != null">#{customerName},</if>
            <if test="customerPhone != null">#{customerPhone},</if>
            <if test="subTotal != null">#{subTotal},</if>
            <if test="tax != null">#{tax},</if>
            <if test="taxRate != null">#{taxRate},</if>
            <if test="total != null">#{total},</if>
            <if test="discount != null">#{discount},</if>
            <if test="createDate != null">#{createDate},</if>
            <if test="manufacturerId != null">#{manufacturerId},</if>
            <if test="color != null">#{color},</if>
        </trim>
    </insert>

    <update id="updateOrderEstimate" parameterType="OrderEstimate">
        update order_estimate
        <trim prefix="SET" suffixOverrides=",">
            <if test="customerId != null">customer_id = #{customerId},</if>
            <if test="customerName != null">customer_name = #{customerName},</if>
            <if test="customerPhone != null">customer_phone = #{customerPhone},</if>
            <if test="subTotal != null">subTotal = #{subTotal},</if>
            <if test="tax != null">tax = #{tax},</if>
            <if test="taxRate != null">tax_rate = #{taxRate},</if>
            <if test="total != null">total = #{total},</if>
            <if test="discount != null">discount = #{discount},</if>
            <if test="createDate != null">Create_date = #{createDate},</if>
            <if test="manufacturerId != null">manufacturer_id = #{manufacturerId},</if>
            <if test="color != null">color = #{color},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteOrderEstimateById" parameterType="Long">
        delete from order_estimate where id = #{id}
    </delete>

    <delete id="deleteOrderEstimateByIds" parameterType="String">
        delete from order_estimate where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteEstimateProductsByEstimateIds" parameterType="String">
        delete from estimate_products where estimate_id in
        <foreach item="estimateId" collection="array" open="(" separator="," close=")">
            #{estimateId}
        </foreach>
    </delete>

    <delete id="deleteEstimateProductsByEstimateId" parameterType="Long">
        delete from estimate_products where estimate_id = #{estimateId}
    </delete>

    <insert id="batchEstimateProducts">
        insert into estimate_products( id, estimate_id, product_code, product_description, product_count, product_price, product_total) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.id}, #{item.estimateId}, #{item.productCode}, #{item.productDescription}, #{item.productCount}, #{item.productPrice}, #{item.productTotal})
        </foreach>
    </insert>
</mapper>